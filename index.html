<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MangiaFortissimo</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* Basic Styles */
        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f4f4f4;
        }

        h1, h2 {
            color: #2c3e50;
            margin-bottom: 10px;
            text-align: center;
        }

        /* Search and Target Inputs */
        .search-target-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
            justify-content: center;
        }

        #foodSearch, .target-input {
            padding: 10px 15px;
            border: none;
            border-radius: 20px;
            background-color: #f0f0f0;
            font-size: 16px;
            flex: 1 1 200px;
            box-sizing: border-box;
        }

        .target-input {
            max-width: 200px;
        }

        /* Toggle Buttons (Categories) */
        .toggle-buttons {
            display: flex;
            overflow-x: auto;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            justify-content: center;
        }

        .toggle-button {
            padding: 10px 15px;
            background-color: #f0f0f0;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: background-color 0.3s;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .toggle-button.active {
            background-color: #3498db;
            color: white;
        }

        /* Food Buttons */
        #foodButtons {
            display: flex;
            overflow-x: auto;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            justify-content: center;
        }

        .food-button {
            padding: 10px 15px;
            background-color: #f0f0f0;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: background-color 0.3s;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .food-button.active {
            background-color: #2ecc71;
            color: white;
        }

        /* Selected Foods (Vertical Scrollable Portion Controls) */
        #selectedFoods {
            max-height: 300px; /* Adjust as needed */
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .food-item {
            background-color: white;
            padding: 10px 15px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .food-item label {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .portion-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .portion-control input[type="range"] {
            width: 150px;
        }

        .portion-control span {
            font-size: 14px;
            color: #555;
            min-width: 40px;
            text-align: right;
        }

        /* Dashboard - Macronutrients */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .progress-section {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
            position: relative;
        }

        .progress-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            position: relative;
            margin: 0 auto 10px;
            background: conic-gradient(
                #3498db calc(var(--progress) * 1%),
                #e0e0e0 0%
            );
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease;
        }

        .progress-circle::before {
            content: '';
            position: absolute;
            top: 10px;
            left: 10px;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: #fff;
        }

        .progress-circle .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #555;
            font-size: 18px;
            font-weight: bold;
        }

        .sub-nutrients {
            margin-top: 10px;
            font-size: 14px;
            color: #555;
            text-align: center;
            white-space: pre-line;
        }

        .top-contributors {
            margin-top: 10px;
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .top-contributors span {
            display: flex;
            align-items: center;
            gap: 3px;
            font-size: 14px;
        }

        /* Dashboard - Vitamins and Minerals */
        .progress-bars-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 20px;
        }

        .progress-bar-section {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .progress-bar-section h2 {
            margin-bottom: 15px;
            text-align: center;
        }

        .progress-bar-row {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .progress-bar-row .nutrient-name {
            width: 100px;
            text-align: left;
            font-weight: 600;
        }

        .progress-bar-row .progress-bar-container {
            flex: 1;
            position: relative;
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            margin: 0 10px;
            display: flex;
            align-items: center;
            justify-content: flex-start; /* Ensure filling from left */
        }

        .progress-bar-row .progress-bar-container::before {
            content: attr(data-percentage) "% (" attr(data-current) " / " attr(data-total) ")";
            position: absolute;
            width: 100%;
            text-align: center;
            font-size: 12px;
            color: #333;
            pointer-events: none;
        }

        .progress-bar-row .progress-bar-fill {
            background-color: #3498db;
            height: 100%;
            border-radius: 10px 0 0 10px;
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-bar-row .contributors {
            width: 100px;
            font-size: 16px;
            color: #555;
            display: flex;
            gap: 5px;
            justify-content: flex-start;
        }

        .contributors span {
            display: flex;
            align-items: center;
            gap: 3px;
        }

        /* Footer */
        footer {
            text-align: center;
            margin-top: 40px;
            font-size: 14px;
            color: #777;
        }

        footer a {
            color: #3498db;
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }

            .progress-circle {
                width: 100px;
                height: 100px;
            }

            .progress-circle::before {
                width: 80px;
                height: 80px;
            }

            .progress-bar-row {
                flex-direction: column;
                align-items: flex-start;
            }

            .progress-bar-row .progress-bar-container {
                margin: 10px 0;
            }

            .progress-bar-row .contributors {
                width: auto;
                flex-wrap: wrap;
                justify-content: flex-start;
            }

            .contributors span {
                flex: 1 1 30%;
            }

            .search-target-container {
                flex-direction: row;
                justify-content: center;
            }

            .food-item {
                flex-direction: row;
                justify-content: space-between;
            }

            .portion-control {
                flex-direction: row;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <h1>MangiaFortissimo</h1>

    <div class="search-target-container">
        <input type="text" id="foodSearch" placeholder="Search foods...">
        <input type="number" id="targetCalories" class="target-input" placeholder="Target Kcal" min="0">
        <input type="number" id="targetProtein" class="target-input" placeholder="Target Protein (g)" min="0">
        <input type="number" id="targetFiber" class="target-input" placeholder="Target Fiber (g)" min="0">
    </div>

    <div class="toggle-buttons">
        <button class="toggle-button active" data-category="all">All üçé</button>
        <button class="toggle-button" data-category="fruits">Fruits üçì</button>
        <button class="toggle-button" data-category="vegetables">Vegetables ü•¶</button>
        <button class="toggle-button" data-category="dairy">Dairy ü•õ</button>
        <button class="toggle-button" data-category="grains">Grains üåæ</button>
        <button class="toggle-button" data-category="protein">Protein ü•©</button>
        <button class="toggle-button" data-category="others">Others üçï</button>
        <button class="toggle-button" data-category="recipe">Recipe üçΩÔ∏è</button>
    </div>

    <div id="foodButtons"></div>
    <div id="selectedFoods"></div>

    <div class="dashboard">
        <!-- Macronutrient Progress Circles -->
        <div class="progress-section">
            <h2>Calories</h2>
            <div class="top-contributors" id="caloriesTop">
                <!-- Top 3 contributors for Calories will be displayed here -->
            </div>
            <div id="caloriesProgress" class="progress-circle">
                <div class="progress-text" id="caloriesText">0%</div>
            </div>
            <div class="sub-nutrients">
                <div id="caloriesRatio">0 / 0 kcal</div>
            </div>
        </div>
        <div class="progress-section">
            <h2>Protein</h2>
            <div class="top-contributors" id="proteinTop">
                <!-- Top 3 contributors for Protein will be displayed here -->
            </div>
            <div id="proteinProgress" class="progress-circle">
                <div class="progress-text" id="proteinText">0%</div>
            </div>
            <div class="sub-nutrients">
                <!-- Additional info can be added here if needed -->
            </div>
        </div>
        <div class="progress-section">
            <h2>Carbs</h2>
            <div class="top-contributors" id="carbsTop">
                <!-- Top 3 contributors for Carbs will be displayed here -->
            </div>
            <div id="carbsProgress" class="progress-circle">
                <div class="progress-text" id="carbsText">0%</div>
            </div>
            <div class="sub-nutrients" id="carbsSubNutrients">
                Total Carbs: 0g<br>
                Sugar: 0g<br>
                Fiber: 0g
            </div>
        </div>
        <div class="progress-section">
            <h2>Fat</h2>
            <div class="top-contributors" id="fatTop">
                <!-- Top 3 contributors for Fat will be displayed here -->
            </div>
            <div id="fatProgress" class="progress-circle">
                <div class="progress-text" id="fatText">0%</div>
            </div>
            <div class="sub-nutrients" id="fatSubNutrients">
                Total Fat: 0g<br>
                Saturated: 0g<br>
                Unsaturated: 0g<br>
                Omega-3: 0g<br>
                Omega-6: 0g
            </div>
        </div>
    </div>

    <div class="progress-bars-section">
        <!-- Vitamins Progress Bars -->
        <div class="progress-bar-section">
            <h2>Vitamins</h2>
            <!-- Vitamin A -->
            <div class="progress-bar-row">
                <div class="nutrient-name">Vitamin A</div>
                <div class="progress-bar-container" id="vitaminAProgressBar" data-percentage="0" data-current="0" data-total="900">
                    <div class="progress-bar-fill"></div>
                </div>
                <div class="contributors" id="vitaminATop">
                    <!-- Top 3 contributors for Vitamin A will be displayed here -->
                </div>
            </div>
            <!-- Vitamin B12 -->
            <div class="progress-bar-row">
                <div class="nutrient-name">Vitamin B12</div>
                <div class="progress-bar-container" id="vitaminB12ProgressBar" data-percentage="0" data-current="0" data-total="2.4">
                    <div class="progress-bar-fill"></div>
                </div>
                <div class="contributors" id="vitaminB12Top">
                    <!-- Top 3 contributors for Vitamin B12 will be displayed here -->
                </div>
            </div>
            <!-- Vitamin C -->
            <div class="progress-bar-row">
                <div class="nutrient-name">Vitamin C</div>
                <div class="progress-bar-container" id="vitaminCProgressBar" data-percentage="0" data-current="0" data-total="90">
                    <div class="progress-bar-fill"></div>
                </div>
                <div class="contributors" id="vitaminCTop">
                    <!-- Top 3 contributors for Vitamin C will be displayed here -->
                </div>
            </div>
            <!-- Vitamin D -->
            <div class="progress-bar-row">
                <div class="nutrient-name">Vitamin D</div>
                <div class="progress-bar-container" id="vitaminDProgressBar" data-percentage="0" data-current="0" data-total="20">
                    <div class="progress-bar-fill"></div>
                </div>
                <div class="contributors" id="vitaminDTop">
                    <!-- Top 3 contributors for Vitamin D will be displayed here -->
                </div>
            </div>
            <!-- Vitamin E -->
            <div class="progress-bar-row">
                <div class="nutrient-name">Vitamin E</div>
                <div class="progress-bar-container" id="vitaminEProgressBar" data-percentage="0" data-current="0" data-total="15">
                    <div class="progress-bar-fill"></div>
                </div>
                <div class="contributors" id="vitaminETop">
                    <!-- Top 3 contributors for Vitamin E will be displayed here -->
                </div>
            </div>
            <!-- Vitamin K -->
            <div class="progress-bar-row">
                <div class="nutrient-name">Vitamin K</div>
                <div class="progress-bar-container" id="vitaminKProgressBar" data-percentage="0" data-current="0" data-total="120">
                    <div class="progress-bar-fill"></div>
                </div>
                <div class="contributors" id="vitaminKTop">
                    <!-- Top 3 contributors for Vitamin K will be displayed here -->
                </div>
            </div>
        </div>

        <!-- Minerals Progress Bars -->
        <div class="progress-bar-section">
            <h2>Minerals</h2>
            <!-- Calcium -->
            <div class="progress-bar-row">
                <div class="nutrient-name">Calcium</div>
                <div class="progress-bar-container" id="calciumProgressBar" data-percentage="0" data-current="0" data-total="1000">
                    <div class="progress-bar-fill"></div>
                </div>
                <div class="contributors" id="calciumTop">
                    <!-- Top 3 contributors for Calcium will be displayed here -->
                </div>
            </div>
            <!-- Magnesium -->
            <div class="progress-bar-row">
                <div class="nutrient-name">Magnesium</div>
                <div class="progress-bar-container" id="magnesiumProgressBar" data-percentage="0" data-current="0" data-total="420">
                    <div class="progress-bar-fill"></div>
                </div>
                <div class="contributors" id="magnesiumTop">
                    <!-- Top 3 contributors for Magnesium will be displayed here -->
                </div>
            </div>
            <!-- Potassium -->
            <div class="progress-bar-row">
                <div class="nutrient-name">Potassium</div>
                <div class="progress-bar-container" id="potassiumProgressBar" data-percentage="0" data-current="0" data-total="4700">
                    <div class="progress-bar-fill"></div>
                </div>
                <div class="contributors" id="potassiumTop">
                    <!-- Top 3 contributors for Potassium will be displayed here -->
                </div>
            </div>
            <!-- Iron -->
            <div class="progress-bar-row">
                <div class="nutrient-name">Iron</div>
                <div class="progress-bar-container" id="ironProgressBar" data-percentage="0" data-current="0" data-total="18">
                    <div class="progress-bar-fill"></div>
                </div>
                <div class="contributors" id="ironTop">
                    <!-- Top 3 contributors for Iron will be displayed here -->
                </div>
            </div>
            <!-- Zinc -->
            <div class="progress-bar-row">
                <div class="nutrient-name">Zinc</div>
                <div class="progress-bar-container" id="zincProgressBar" data-percentage="0" data-current="0" data-total="11">
                    <div class="progress-bar-fill"></div>
                </div>
                <div class="contributors" id="zincTop">
                    <!-- Top 3 contributors for Zinc will be displayed here -->
                </div>
            </div>
            <!-- Selenium -->
            <div class="progress-bar-row">
                <div class="nutrient-name">Selenium</div>
                <div class="progress-bar-container" id="seleniumProgressBar" data-percentage="0" data-current="0" data-total="55">
                    <div class="progress-bar-fill"></div>
                </div>
                <div class="contributors" id="seleniumTop">
                    <!-- Top 3 contributors for Selenium will be displayed here -->
                </div>
            </div>
            <!-- Sodium -->
            <div class="progress-bar-row">
                <div class="nutrient-name">Sodium</div>
                <div class="progress-bar-container" id="sodiumProgressBar" data-percentage="0" data-current="0" data-total="2300">
                    <div class="progress-bar-fill"></div>
                </div>
                <div class="contributors" id="sodiumTop">
                    <!-- Top 3 contributors for Sodium will be displayed here -->
                </div>
            </div>
        </div>
    </div>

    <footer>
        <p>micmer - <a href="https://linktr.ee/micmer">https://linktr.ee/micmer</a></p>
    </footer>

    <script src="foodData.js"></script>
    <script src="recipes.js"></script>
    <script>
        <!-- Import external data files -->


        // ======= Daily Values =======
        let dailyValues = {
              calories: 2000,
              protein: 50,
              carbs: 300,
              fat: 65,
              fiber: 40,
              omega3: 2, // In grams
              omega6: 5, // In grams
              calcium: 1000,
              magnesium: 450,
              potassium: 6000,
              iron: 8,
              zinc: 15,
              selenium: 55,
              sodium: 1500,
              vitaminA: 900,
              vitaminB12: 2400,
              vitaminC: 90,
              vitaminD: 600,
              vitaminE: 15,
              vitaminK: 120
          };
        // ============================

        const buttonContainer = document.getElementById('foodButtons');
        const selectedFoodsContainer = document.getElementById('selectedFoods');
        const toggleButtons = document.querySelectorAll('.toggle-button');

        let selectedFoods = new Set();

        // Function to sanitize IDs
        function sanitizeID(str) {
            return str.replace(/[^a-zA-Z0-9]/g, '_');
        }

        // Create food buttons with data-food attribute for accurate mapping
        for (let food in foodData) {
            let button = document.createElement('button');
            button.textContent = `${foodData[food].emoji} ${food}`;
            button.className = 'food-button';
            button.dataset.category = foodData[food].category;
            button.dataset.food = food; // Add data-food attribute
            button.onclick = () => toggleFood(food, button);
            buttonContainer.appendChild(button);
        }

        // Create recipe buttons
        const recipeButton = document.querySelector('.toggle-button[data-category="recipe"]');
        for (let recipe in recipes) {
            let button = document.createElement('button');
            button.textContent = `${recipe} üçΩÔ∏è`;
            button.className = 'food-button recipe-button';
            button.dataset.category = 'recipe';
            button.dataset.food = recipe; // Add data-food attribute
            button.onclick = () => toggleRecipe(recipe, button);
            buttonContainer.appendChild(button);
        }

        toggleButtons.forEach(button => {
            button.addEventListener('click', () => {
                const category = button.dataset.category;
                toggleButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');

                const foodButtons = document.querySelectorAll('.food-button');
                foodButtons.forEach(foodButton => {
                    const foodCategory = foodButton.dataset.category;
                    if (category === 'all' || foodCategory === category) {
                        foodButton.style.display = 'inline-block';
                    } else {
                        foodButton.style.display = 'none';
                    }
                });
                updateNutritionTable();
            });
        });

        function toggleFood(food, button) {
            if (selectedFoods.has(food)) {
                selectedFoods.delete(food);
                button.classList.remove('active');
                removeSlider(food);
            } else {
                selectedFoods.add(food);
                button.classList.add('active');
                addSlider(food);
            }
            updateNutritionTable();
        }

        function toggleRecipe(recipe, button) {
            if (selectedFoods.has(recipe)) {
                // Deselect recipe and its components
                selectedFoods.delete(recipe);
                button.classList.remove('active');
                recipes[recipe].forEach(food => {
                    selectedFoods.delete(food);
                    const foodButton = document.querySelector(`.food-button[data-food="${food}"]`);
                    if (foodButton) {
                        foodButton.classList.remove('active');
                        removeSlider(food);
                    }
                });
            } else {
                // Select recipe and its components
                selectedFoods.add(recipe);
                button.classList.add('active');
                recipes[recipe].forEach(food => {
                    selectedFoods.add(food);
                    const foodButton = document.querySelector(`.food-button[data-food="${food}"]`);
                    if (foodButton) {
                        foodButton.classList.add('active');
                        addSlider(food);
                    }
                });
            }
            updateNutritionTable();
        }

        function addSlider(food) {
            // Prevent adding multiple sliders for the same food
            if (document.getElementById(`${sanitizeID(food)}-slider`)) return;

            const div = document.createElement('div');
            div.className = 'food-item';
            div.innerHTML = `
                <label>${foodData[food].emoji} ${food}</label>
                <div class="portion-control">
                    <input type="range" min="0" max="500" value="${foodData[food].grams}" id="${sanitizeID(food)}-slider">
                    <span id="${sanitizeID(food)}-value">${foodData[food].grams}g</span>
                </div>
            `;
            selectedFoodsContainer.appendChild(div);

            const slider = document.getElementById(`${sanitizeID(food)}-slider`);
            const output = document.getElementById(`${sanitizeID(food)}-value`);
            slider.oninput = function () {
                output.textContent = this.value + 'g';
                updateNutritionTable();
            }
        }

        function removeSlider(food) {
            const slider = document.getElementById(`${sanitizeID(food)}-slider`);
            if (slider) {
                slider.parentElement.parentElement.remove();
            }
        }

        function updateNutritionTable() {
            if (selectedFoods.size === 0) {
                resetProgressBars();
                return;
            }

            // Retrieve target values
            const targetCalories = parseFloat(document.getElementById('targetCalories').value) || dailyValues.calories;
            const targetProtein = parseFloat(document.getElementById('targetProtein').value) || dailyValues.protein;
            const targetFiber = parseFloat(document.getElementById('targetFiber').value) || dailyValues.fiber;

            let totals = {
                calories: 0, totalFat: 0, saturatedFat: 0,
                unsaturatedFat: 0, omega3: 0, omega6: 0,
                carbs: 0, sugar: 0, protein: 0, fiber: 0,
                vitaminA: 0, vitaminB12: 0, vitaminC: 0, vitaminD: 0, vitaminE: 0, vitaminK: 0,
                calcium: 0, magnesium: 0, potassium: 0, iron: 0, zinc: 0, selenium: 0, sodium: 0
            };

            // Track contributors for vitamins and minerals
            let nutrientContributors = {
                vitaminA: {},
                vitaminB12: {},
                vitaminC: {},
                vitaminD: {},
                vitaminE: {},
                vitaminK: {},
                calcium: {},
                magnesium: {},
                potassium: {},
                iron: {},
                zinc: {},
                selenium: {},
                sodium: {}
            };

            selectedFoods.forEach(food => {
                if (recipes[food]) {
                    // If it's a recipe, skip since components are already added
                    return;
                }
                if (!foodData[food]) {
                    // If food data is missing, skip
                    return;
                }
                const sliderValue = parseFloat(document.getElementById(`${sanitizeID(food)}-slider`).value);
                const ratio = sliderValue / foodData[food].grams;
                for (let nutrient in totals) {
                    if (foodData[food][nutrient] !== undefined) {
                        // Convert Omegas from mg to g
                        if (nutrient === 'omega3' || nutrient === 'omega6') {
                            totals[nutrient] += (foodData[food][nutrient] * ratio) / 1000;
                        } else {
                            totals[nutrient] += foodData[food][nutrient] * ratio;
                        }
                        // Track contributors for vitamins and minerals
                        if (nutrientContributors[nutrient] !== undefined) {
                            if (!nutrientContributors[nutrient][food]) {
                                nutrientContributors[nutrient][food] = 0;
                            }
                            if (nutrient === 'omega3' || nutrient === 'omega6') {
                                nutrientContributors[nutrient][food] += (foodData[food][nutrient] * ratio) / 1000;
                            } else {
                                nutrientContributors[nutrient][food] += foodData[food][nutrient] * ratio;
                            }
                        }
                    }
                }

                // Calculate unsaturated fat (totalFat - saturatedFat)
                if (nutrientContributors['unsaturatedFat'] !== undefined && foodData[food]['totalFat'] !== undefined && foodData[food]['saturatedFat'] !== undefined) {
                    const unsatFat = (foodData[food]['totalFat'] - (foodData[food]['saturatedFat'] || 0)) * ratio;
                    totals['unsaturatedFat'] += unsatFat;
                }
            });

            // Update Macronutrient Circles
            updateMacroCircles(totals, targetCalories, targetProtein, targetFiber);

            // Update Top 3 Contributors for Macronutrients
            updateTopContributors(totals);

            // Update Vitamins and Minerals Progress Bars
            updateVitaminsAndMinerals(totals, nutrientContributors);
        }

        function updateMacroCircles(totals, targetCalories, targetProtein, targetFiber) {
            // Calories
            const caloriesProgress = Math.min((totals.calories / targetCalories) * 100, 100);
            const caloriesCircle = document.getElementById('caloriesProgress');
            const caloriesText = document.getElementById('caloriesText');
            const caloriesRatio = document.getElementById('caloriesRatio');
            if (caloriesCircle && caloriesText && caloriesRatio) {
                caloriesCircle.style.setProperty('--progress', caloriesProgress);
                caloriesText.textContent = `${caloriesProgress.toFixed(0)}%`;
                caloriesRatio.textContent = `${totals.calories.toFixed(0)} / ${targetCalories} kcal`;
            }

            // Protein
            const proteinProgress = Math.min((totals.protein / targetProtein) * 100, 100);
            const proteinCircle = document.getElementById('proteinProgress');
            const proteinText = document.getElementById('proteinText');
            if (proteinCircle && proteinText) {
                proteinCircle.style.setProperty('--progress', proteinProgress);
                proteinText.textContent = `${proteinProgress.toFixed(0)}%`;
            }

            // Carbs
            const carbsProgress = Math.min((totals.carbs / dailyValues.carbs) * 100, 100);
            const carbsCircle = document.getElementById('carbsProgress');
            const carbsText = document.getElementById('carbsText');
            const carbsSub = document.getElementById('carbsSubNutrients');
            if (carbsCircle && carbsText && carbsSub) {
                carbsCircle.style.setProperty('--progress', carbsProgress);
                carbsText.textContent = `${carbsProgress.toFixed(0)}%`;
                carbsSub.innerHTML = `Total Carbs: ${totals.carbs.toFixed(1)}g<br>Sugar: ${totals.sugar.toFixed(1)}g<br>Fiber: ${totals.fiber.toFixed(1)}g`;
            }

            // Fat
            const fatProgress = Math.min((totals.totalFat / dailyValues.fat) * 100, 100);
            const fatCircle = document.getElementById('fatProgress');
            const fatText = document.getElementById('fatText');
            const fatSub = document.getElementById('fatSubNutrients');
            if (fatCircle && fatText && fatSub) {
                fatCircle.style.setProperty('--progress', fatProgress);
                fatText.textContent = `${fatProgress.toFixed(0)}%`;
                fatSub.innerHTML = `Total Fat: ${totals.totalFat.toFixed(1)}g<br>Saturated: ${totals.saturatedFat.toFixed(1)}g<br>Unsaturated: ${totals.unsaturatedFat.toFixed(1)}g<br>Omega-3: ${totals.omega3.toFixed(1)}g<br>Omega-6: ${totals.omega6.toFixed(1)}g`;
            }
        }

        function updateTopContributors(totals) {
            // Define top contributors for macronutrients
            const macronutrients = ['calories', 'protein', 'carbs', 'fat'];
            macronutrients.forEach(nutrient => {
                let contributors = {};
                for (let food in foodData) {
                    if (foodData[food][nutrient] !== undefined && selectedFoods.has(food)) {
                        contributors[food] = foodData[food][nutrient];
                    }
                }
                // Sort and get top 3
                const sorted = Object.entries(contributors).sort((a, b) => b[1] - a[1]).slice(0, 3);
                // Display above the respective progress circle
                const topContributorsDiv = document.getElementById(`${nutrient}Top`);
                if (topContributorsDiv) {
                    let html = '';
                    sorted.forEach(([food, value]) => {
                        if (nutrient === 'omega3' || nutrient === 'omega6') {
                            html += `${foodData[food].emoji} ${value.toFixed(2)}g `;
                        } else {
                            html += `${foodData[food].emoji} ${value.toFixed(1)} `;
                        }
                    });
                    topContributorsDiv.innerHTML = html.trim();
                }
            });
        }

        function updateVitaminsAndMinerals(totals, nutrientContributors) {
            // Vitamins
            const vitamins = ['vitaminA', 'vitaminB12', 'vitaminC', 'vitaminD', 'vitaminE', 'vitaminK'];
            vitamins.forEach(vitamin => {
                const progressBar = document.getElementById(`${vitamin}ProgressBar`);
                const topContributorsDiv = document.getElementById(`${vitamin}Top`);
                if (progressBar && topContributorsDiv) {
                    const current = totals[vitamin];
                    const total = dailyValues[vitamin];
                    const progress = Math.min((current / total) * 100, 100);
                    const fill = progressBar.querySelector('.progress-bar-fill');
                    fill.style.width = `${progress}%`;
                    progressBar.setAttribute('data-percentage', progress.toFixed(0));
                    progressBar.setAttribute('data-current', current.toFixed(1));
                    progressBar.setAttribute('data-total', total);

                    // Get top 3 contributors
                    const contributors = nutrientContributors[vitamin];
                    const sortedContributors = Object.entries(contributors)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 3);
                    
                    // Build contributors display
                    let contributorsHTML = '';
                    sortedContributors.forEach(([food, value]) => {
                        contributorsHTML += `<span>${foodData[food].emoji} ${value.toFixed(1)}</span>`;
                    });
                    topContributorsDiv.innerHTML = contributorsHTML;
                }
            });

            // Minerals
            const minerals = ['calcium', 'magnesium', 'potassium', 'iron', 'zinc', 'selenium', 'sodium'];
            minerals.forEach(mineral => {
                const progressBar = document.getElementById(`${mineral}ProgressBar`);
                const topContributorsDiv = document.getElementById(`${mineral}Top`);
                if (progressBar && topContributorsDiv) {
                    const current = totals[mineral];
                    const total = dailyValues[mineral];
                    const progress = Math.min((current / total) * 100, 100);
                    const fill = progressBar.querySelector('.progress-bar-fill');
                    fill.style.width = `${progress}%`;
                    progressBar.setAttribute('data-percentage', progress.toFixed(0));
                    progressBar.setAttribute('data-current', current.toFixed(1));
                    progressBar.setAttribute('data-total', total);

                    // Get top 3 contributors
                    const contributors = nutrientContributors[mineral];
                    const sortedContributors = Object.entries(contributors)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 3);
                    
                    // Build contributors display
                    let contributorsHTML = '';
                    sortedContributors.forEach(([food, value]) => {
                        contributorsHTML += `<span>${foodData[food].emoji} ${value.toFixed(1)}</span>`;
                    });
                    topContributorsDiv.innerHTML = contributorsHTML;
                }
            });
        }

        function resetProgressBars() {
            // Reset progress circles
            const progressCircles = document.querySelectorAll('.progress-circle');
            progressCircles.forEach(circle => {
                circle.style.setProperty('--progress', 0);
                const text = circle.querySelector('.progress-text');
                if (text) text.textContent = '0%';
            });

            // Reset sub-nutrients info
            document.getElementById('caloriesRatio').textContent = `0 / 0 kcal`;
            document.getElementById('carbsSubNutrients').innerHTML = `Total Carbs: 0g<br>Sugar: 0g<br>Fiber: 0g`;
            document.getElementById('fatSubNutrients').innerHTML = `Total Fat: 0g<br>Saturated: 0g<br>Unsaturated: 0g<br>Omega-3: 0g<br>Omega-6: 0g`;

            // Reset progress bars
            const progressBars = document.querySelectorAll('.progress-bar-container');
            progressBars.forEach(bar => {
                const fill = bar.querySelector('.progress-bar-fill');
                fill.style.width = '0%';
                bar.setAttribute('data-percentage', '0');
                bar.setAttribute('data-current', '0');
                // data-total remains as is
            });

            // Clear top contributors
            const topContributors = document.querySelectorAll('.contributors');
            topContributors.forEach(div => div.innerHTML = '');
        }

        // Initialize the dashboard
        updateNutritionTable();

        // Search functionality
        const searchInput = document.getElementById('foodSearch');

        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const foodButtons = document.querySelectorAll('.food-button');
            
            foodButtons.forEach(button => {
                const foodName = button.dataset.food.toLowerCase();
                if (foodName.includes(searchTerm)) {
                    button.style.display = 'inline-block';
                } else {
                    button.style.display = 'none';
                }
            });
        });

        // Target Inputs functionality
        const targetCaloriesInput = document.getElementById('targetCalories');
        const targetProteinInput = document.getElementById('targetProtein');
        const targetFiberInput = document.getElementById('targetFiber');

        targetCaloriesInput.addEventListener('input', updateNutritionTable);
        targetProteinInput.addEventListener('input', updateNutritionTable);
        targetFiberInput.addEventListener('input', updateNutritionTable);
    </script>
</body>
</html>
